---
import { ViewTransitions } from 'astro:transitions';
import '../styles/global.css';
import { diensten } from '../data/diensten';

interface Props {
  title: string;
  description: string;
  ogImage?: string;
  canonical?: string;
  keywords?: string;
  noindex?: boolean;
  faqSchema?: { vraag: string; antwoord: string }[];
  schemaOverride?: Record<string, unknown>;
  serviceSchema?: Record<string, unknown>;
  breadcrumbs?: { name: string; url: string }[];
  aggregateRating?: { ratingValue: number; reviewCount: number };
}

const {
  title,
  description,
  ogImage,
  canonical,
  keywords,
  noindex = false,
  faqSchema,
  schemaOverride,
  serviceSchema,
  breadcrumbs,
  aggregateRating,
} = Astro.props;

const siteUrl = 'https://slim-klussen.be';
const pageUrl = canonical || Astro.url.href;
const ogImg = ogImage || `${siteUrl}/hero.webp`;

const defaultSchema: Record<string, unknown> = {
  "@context": "https://schema.org",
  "@type": "HomeAndConstructionBusiness",
  "name": "SLIM â€” Klussen & Renoveren",
  "image": `${siteUrl}/hero.webp`,
  "logo": `${siteUrl}/favicon.png`,
  "description": "Ervaren klusjesman in de regio Wetteren. Herstellingen, renovaties, montage en recuperatie.",
  "url": siteUrl,
  "telephone": "+32487726546",
  "email": "slim.klussen@gmail.com",
  "priceRange": "$$",
  "currenciesAccepted": "EUR",
  "paymentAccepted": "Cash, Overschrijving",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Wanzelestraat 27",
    "addressLocality": "Schellebelle",
    "addressRegion": "Oost-Vlaanderen",
    "postalCode": "9260",
    "addressCountry": "BE"
  },
  "geo": {
    "@type": "GeoCoordinates",
    "latitude": 51.0038,
    "longitude": 3.8842
  },
  "areaServed": [
    { "@type": "State", "name": "Oost-Vlaanderen" },
    { "@type": "City", "name": "Gent" },
    { "@type": "City", "name": "Aalst" },
    { "@type": "City", "name": "Sint-Niklaas" },
    { "@type": "City", "name": "Dendermonde" },
    { "@type": "City", "name": "Wetteren" },
    { "@type": "City", "name": "Lokeren" },
    { "@type": "City", "name": "Zele" },
    { "@type": "City", "name": "Hamme" },
    { "@type": "City", "name": "Temse" },
    { "@type": "City", "name": "Beveren" },
    { "@type": "City", "name": "Destelbergen" },
    { "@type": "City", "name": "Merelbeke" },
    { "@type": "City", "name": "Melle" },
    { "@type": "City", "name": "Laarne" },
    { "@type": "City", "name": "Berlare" },
    { "@type": "City", "name": "Wichelen" }
  ],
  "openingHoursSpecification": [
    {
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": ["Monday","Tuesday","Wednesday","Thursday","Friday"],
      "opens": "08:00",
      "closes": "18:00"
    },
    {
      "@type": "OpeningHoursSpecification",
      "dayOfWeek": "Saturday",
      "opens": "08:00",
      "closes": "18:00"
    }
  ],
  "vatID": "BE1025378882",
  "contactPoint": {
    "@type": "ContactPoint",
    "telephone": "+32487726546",
    "contactType": "customer service",
    "availableLanguage": ["Dutch"],
    "areaServed": "BE"
  },
  "sameAs": [
    "https://wa.me/32487726546"
  ],
  "hasOfferCatalog": {
    "@type": "OfferCatalog",
    "name": "Diensten",
    "itemListElement": diensten.map((d) => ({
      "@type": "Offer",
      "itemOffered": {
        "@type": "Service",
        "name": d.naam,
        "description": d.korteOmschrijving,
        "url": `${siteUrl}/diensten/${d.slug}`
      }
    }))
  }
};

// Add aggregateRating if provided
if (aggregateRating) {
  defaultSchema["aggregateRating"] = {
    "@type": "AggregateRating",
    "ratingValue": aggregateRating.ratingValue,
    "reviewCount": aggregateRating.reviewCount,
    "bestRating": 5,
    "worstRating": 1
  };
}

const businessSchema = schemaOverride
  ? { "@context": "https://schema.org", ...schemaOverride }
  : defaultSchema;

const faqPageSchema = faqSchema && faqSchema.length > 0
  ? {
      "@context": "https://schema.org",
      "@type": "FAQPage",
      "mainEntity": faqSchema.map((faq) => ({
        "@type": "Question",
        "name": faq.vraag,
        "acceptedAnswer": {
          "@type": "Answer",
          "text": faq.antwoord
        }
      }))
    }
  : null;

const breadcrumbSchema = breadcrumbs && breadcrumbs.length > 0
  ? {
      "@context": "https://schema.org",
      "@type": "BreadcrumbList",
      "itemListElement": breadcrumbs.map((crumb, index) => ({
        "@type": "ListItem",
        "position": index + 1,
        "name": crumb.name,
        "item": crumb.url
      }))
    }
  : null;
---

<!DOCTYPE html>
<html lang="nl">
  <head>
    <meta charset="utf-8" />
    <link rel="icon" type="image/png" href="/favicon.png" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="generator" content={Astro.generator} />

    <!-- SEO -->
    <title>{title}</title>
    <meta name="description" content={description} />
    {keywords && <meta name="keywords" content={keywords} />}
    {noindex
      ? <meta name="robots" content="noindex, nofollow" />
      : <meta name="robots" content="index, follow" />
    }
    <link rel="canonical" href={pageUrl} />

    <!-- Open Graph -->
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:type" content="website" />
    <meta property="og:locale" content="nl_BE" />
    <meta property="og:url" content={pageUrl} />
    <meta property="og:image" content={ogImg} />
    <meta property="og:image:alt" content="SLIM Klussen & Renoveren - Klusjesman regio Wetteren" />
    <meta property="og:image:width" content="800" />
    <meta property="og:image:height" content="1066" />
    <meta property="og:site_name" content="SLIM Klussen & Renoveren" />

    <!-- Twitter Card -->
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content={title} />
    <meta name="twitter:description" content={description} />
    <meta name="twitter:image" content={ogImg} />

    <!-- Preload critical assets -->
    <link rel="preload" as="image" type="image/webp" href="/hero.webp" />

    <!-- Fonts - Plus Jakarta Sans (headings) + Inter (body) -->
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap"
      rel="stylesheet"
      media="print"
      onload="this.media='all'"
    />
    <noscript>
      <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Plus+Jakarta+Sans:wght@600;700;800&display=swap" rel="stylesheet" />
    </noscript>

    <!-- View Transitions -->
    <ViewTransitions />

    <!-- Schema.org JSON-LD -->
    <script type="application/ld+json" set:html={JSON.stringify(businessSchema)} />

    {faqPageSchema && (
      <script type="application/ld+json" set:html={JSON.stringify(faqPageSchema)} />
    )}

    {breadcrumbSchema && (
      <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
    )}

    {serviceSchema && (
      <script type="application/ld+json" set:html={JSON.stringify({ "@context": "https://schema.org", ...serviceSchema })} />
    )}
  </head>
  <body class="bg-white antialiased">
    <div id="scroll-progress" class="fixed top-0 left-0 h-[3px] bg-[#d67b3a] z-[100]" style="width: 0%; transform-origin: left;"></div>
    <slot transition:animate="fade" />

    <script>
      // Scroll progress bar
      const progressBar = document.getElementById('scroll-progress');
      if (progressBar) {
        window.addEventListener('scroll', () => {
          const scrollTop = window.scrollY;
          const docHeight = document.documentElement.scrollHeight - window.innerHeight;
          const progress = docHeight > 0 ? (scrollTop / docHeight) * 100 : 0;
          progressBar.style.width = progress + '%';
        }, { passive: true });
      }

      // Smart nav: hide on scroll down, show on scroll up
      const header = document.querySelector('header');
      let lastScrollY = 0;
      let ticking = false;

      function updateNav() {
        const currentScrollY = window.scrollY;
        if (header) {
          if (currentScrollY > lastScrollY && currentScrollY > 100) {
            header.style.transform = 'translateY(-100%)';
            header.style.transition = 'transform 0.3s ease';
          } else {
            header.style.transform = 'translateY(0)';
            header.style.transition = 'transform 0.3s ease';
          }
        }
        lastScrollY = currentScrollY;
        ticking = false;
      }

      window.addEventListener('scroll', () => {
        if (!ticking) {
          requestAnimationFrame(updateNav);
          ticking = true;
        }
      }, { passive: true });

      // Lightweight scroll reveal (replaces GSAP)
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            entry.target.classList.add('is-visible');
            observer.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });

      document.querySelectorAll('[data-animate]').forEach(el => observer.observe(el));

      // Stagger children animation
      const staggerObserver = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) {
            const children = entry.target.children;
            Array.from(children).forEach((child, i) => {
              (child as HTMLElement).style.transitionDelay = `${i * 80}ms`;
              child.classList.add('is-visible');
            });
            staggerObserver.unobserve(entry.target);
          }
        });
      }, { threshold: 0.1 });

      document.querySelectorAll('[data-animate-stagger]').forEach(el => staggerObserver.observe(el));

      // Re-init on View Transitions navigation
      document.addEventListener('astro:page-load', () => {
        document.querySelectorAll('[data-animate]:not(.is-visible)').forEach(el => observer.observe(el));
        document.querySelectorAll('[data-animate-stagger]:not(.is-visible)').forEach(el => staggerObserver.observe(el));
      });
    </script>
  </body>
</html>
